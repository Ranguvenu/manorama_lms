{"version":3,"file":"inplace_editable.min.js","sources":["../src/inplace_editable.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * AJAX helper for the inline editing a value.\r\n *\r\n * This script is automatically included from template core/inplace_editable\r\n * It registers a click-listener on [data-inplaceeditablelink] link (the \"inplace edit\" icon),\r\n * then replaces the displayed value with an input field. On \"Enter\" it sends a request\r\n * to web service core_update_inplace_editable, which invokes the specified callback.\r\n * Any exception thrown by the web service (or callback) is displayed as an error popup.\r\n *\r\n * @module     core/inplace_editable\r\n * @package    core\r\n * @copyright  2016 Marina Glancy\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n * @since      3.1\r\n */\r\ndefine(['jquery', 'core/ajax', 'core/templates', 'core/notification', 'core/str', 'core/config', 'core/url'],\r\n        function($, ajax, templates, notification, str, cfg, url) {\r\n\r\n    $('body').on('click keypress', '[data-inplaceeditable] [data-inplaceeditablelink]', function(e) {\r\n        if (e.type === 'keypress' && e.keyCode !== 13) {\r\n            return;\r\n        }\r\n        e.stopImmediatePropagation();\r\n        e.preventDefault();\r\n        var target = $(this),\r\n            mainelement = target.closest('[data-inplaceeditable]');\r\n\r\n        var addSpinner = function(element) {\r\n            element.addClass('updating');\r\n            var spinner = element.find('img.spinner');\r\n            if (spinner.length) {\r\n                spinner.show();\r\n            } else {\r\n                spinner = $('<img/>')\r\n                        .attr('src', url.imageUrl('i/loading_small'))\r\n                        .addClass('spinner').addClass('smallicon')\r\n                    ;\r\n                element.append(spinner);\r\n            }\r\n        };\r\n\r\n        var removeSpinner = function(element) {\r\n            element.removeClass('updating');\r\n            element.find('img.spinner').hide();\r\n        };\r\n\r\n        var updateValue = function(mainelement, value) {\r\n            addSpinner(mainelement);\r\n            ajax.call([{\r\n                    methodname: 'block_reportdashboard_inplace_editable_dashboard',\r\n                    args: {\r\n                        prevoiusdashboardname: mainelement.attr('data-prevoiusdashboardname'),\r\n                        pagetypepattern: mainelement.attr('data-pagetypepattern'),\r\n                        subpagepattern: mainelement.attr('data-subpagepattern'),\r\n                        // component: mainelement.attr('data-component'),\r\n                        // itemtype: mainelement.attr('data-itemtype'),\r\n                        value: value\r\n                    },\r\n                    done: function(data) {\r\n                        var roleshortname = mainelement.attr('data-roleshortname');\r\n\r\n                        // templates.render('core/inplace_editable', data).done(function(html, js) {\r\n                        //     var newelement = $(html);\r\n                        //     templates.replaceNode(mainelement, newelement, js);\r\n                        //     newelement.find('[data-inplaceeditablelink]').focus();\r\n                        //     newelement.trigger({type: 'updated', ajaxreturn: data, oldvalue: oldvalue});\r\n                        // });\r\n                        if(roleshortname == ''){\r\n                            window.location.href = M.cfg.wwwroot+'/blocks/reportdashboard/dashboard.php?dashboardurl='+data;\r\n                        } else{\r\n                            window.location.href = M.cfg.wwwroot+'/blocks/reportdashboard/dashboard.php?dashboardurl='+data+'&role='+roleshortname;\r\n                        }\r\n                    },\r\n                    fail: function(ex) {\r\n                        var e = $.Event('updatefailed', {\r\n                                exception: ex,\r\n                                newvalue: value\r\n                            });\r\n                        removeSpinner(mainelement);\r\n                        mainelement.trigger(e);\r\n                        if (!e.isDefaultPrevented()) {\r\n                            notification.exception(ex);\r\n                        }\r\n                    }\r\n                }], true);\r\n        };\r\n\r\n        var turnEditingOff = function(el) {\r\n            el.find('input').off();\r\n            el.find('select').off();\r\n            el.html(el.attr('data-oldcontent'));\r\n            el.removeAttr('data-oldcontent');\r\n            el.removeClass('inplaceeditingon');\r\n            el.find('[data-inplaceeditablelink]').focus();\r\n        };\r\n\r\n        var turnEditingOffEverywhere = function() {\r\n            $('span.inplaceeditable.inplaceeditingon').each(function() {\r\n                turnEditingOff($(this));\r\n            });\r\n        };\r\n\r\n        var uniqueId = function(prefix, idlength) {\r\n            var uniqid = prefix,\r\n                i;\r\n            for (i = 0; i < idlength; i++) {\r\n                uniqid += String(Math.floor(Math.random() * 10));\r\n            }\r\n            // Make sure this ID is not already taken by an existing element.\r\n            if ($(\"#\" + uniqid).length === 0) {\r\n                return uniqid;\r\n            }\r\n            return uniqueId(prefix, idlength);\r\n        };\r\n\r\n        var turnEditingOnText = function(el) {\r\n            str.get_string('edittitleinstructions').done(function(s) {\r\n                var instr = $('<span class=\"editinstructions\">' + s + '</span>').\r\n                        attr('id', uniqueId('id_editinstructions_', 20)),\r\n                    inputelement = $('<input type=\"text\"/>').\r\n                        attr('id', uniqueId('id_inplacevalue_', 20)).\r\n                        attr('value', el.attr('data-value')).\r\n                        attr('aria-describedby', instr.attr('id')).\r\n                        addClass('ignoredirty').\r\n                        addClass('form-control'),\r\n                    lbl = $('<label class=\"accesshide\">' + mainelement.attr('data-editlabel') + '</label>').\r\n                        attr('for', inputelement.attr('id'));\r\n                el.html('').append(instr).append(lbl).append(inputelement);\r\n\r\n                inputelement.focus();\r\n                inputelement.select();\r\n                inputelement.on('keyup keypress focusout', function(e) {\r\n                    if (cfg.behatsiterunning && e.type === 'focusout') {\r\n                        // Behat triggers focusout too often.\r\n                        return;\r\n                    }\r\n                    if (e.type === 'keypress' && e.keyCode === 13) {\r\n                        // We need 'keypress' event for Enter because keyup/keydown would catch Enter that was\r\n                        // pressed in other fields.\r\n                        var val = inputelement.val();\r\n                        turnEditingOff(el);\r\n                        updateValue(el, val);\r\n                    }\r\n                    if ((e.type === 'keyup' && e.keyCode === 27) || e.type === 'focusout') {\r\n                        // We need 'keyup' event for Escape because keypress does not work with Escape.\r\n                        turnEditingOff(el);\r\n                    }\r\n                });\r\n            });\r\n        };\r\n\r\n        var turnEditingOnToggle = function(el, newvalue) {\r\n            turnEditingOff(el);\r\n            updateValue(el, newvalue);\r\n        };\r\n\r\n        var turnEditingOnSelect = function(el, options) {\r\n            var i,\r\n                inputelement = $('<select></select>').\r\n                    attr('id', uniqueId('id_inplacevalue_', 20)).\r\n                    addClass('custom-select'),\r\n                lbl = $('<label class=\"accesshide\">' + mainelement.attr('data-editlabel') + '</label>')\r\n                    .attr('for', inputelement.attr('id'));\r\n            for (i in options) {\r\n                inputelement\r\n                    .append($('<option>')\r\n                    .attr('value', options[i].key)\r\n                    .html(options[i].value));\r\n            }\r\n            inputelement.val(el.attr('data-value'));\r\n            el.html('')\r\n                .append(lbl)\r\n                .append(inputelement);\r\n\r\n            inputelement.focus();\r\n            inputelement.select();\r\n            inputelement.on('keyup change focusout', function(e) {\r\n                if (cfg.behatsiterunning && e.type === 'focusout') {\r\n                    // Behat triggers focusout too often.\r\n                    return;\r\n                }\r\n                if (e.type === 'change') {\r\n                    var val = inputelement.val();\r\n                    turnEditingOff(el);\r\n                    updateValue(el, val);\r\n                }\r\n                if ((e.type === 'keyup' && e.keyCode === 27) || e.type === 'focusout') {\r\n                    // We need 'keyup' event for Escape because keypress does not work with Escape.\r\n                    turnEditingOff(el);\r\n                }\r\n            });\r\n        };\r\n\r\n        var turnEditingOn = function(el) {\r\n            el.addClass('inplaceeditingon');\r\n            el.attr('data-oldcontent', el.html());\r\n\r\n            var type = el.attr('data-type');\r\n            var options = el.attr('data-options');\r\n\r\n            if (type === 'toggle') {\r\n                turnEditingOnToggle(el, options);\r\n            } else if (type === 'select') {\r\n                turnEditingOnSelect(el, $.parseJSON(options));\r\n            } else {\r\n                turnEditingOnText(el);\r\n            }\r\n        };\r\n\r\n        // Turn editing on for the current element and register handler for Enter/Esc keys.\r\n        turnEditingOffEverywhere();\r\n        turnEditingOn(mainelement);\r\n\r\n    });\r\n\r\n    return {};\r\n});\r\n"],"names":["define","$","ajax","templates","notification","str","cfg","url","on","e","type","keyCode","stopImmediatePropagation","preventDefault","mainelement","this","closest","updateValue","value","element","addClass","spinner","find","length","show","attr","imageUrl","append","addSpinner","call","methodname","args","prevoiusdashboardname","pagetypepattern","subpagepattern","done","data","roleshortname","window","location","href","M","wwwroot","fail","ex","Event","exception","newvalue","removeClass","hide","trigger","isDefaultPrevented","turnEditingOff","el","off","html","removeAttr","focus","uniqueId","prefix","idlength","i","uniqid","String","Math","floor","random","each","options","turnEditingOnToggle","inputelement","lbl","key","val","select","behatsiterunning","turnEditingOnSelect","parseJSON","get_string","s","instr","turnEditingOnText","turnEditingOn"],"mappings":"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"}